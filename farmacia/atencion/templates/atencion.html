{% extends "index.html"%}


{% block main %}
<!-- Content Wrapper. Contains page content -->
<div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <div class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1 class="m-0 text-dark">Modulo de atencion medica</h1>
          </div><!-- /.col -->
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              
            </ol>
          </div><!-- /.col -->
        </div><!-- /.row -->
      </div><!-- /.container-fluid -->
    </div>
    <!-- /.content-header -->

    <!-- Main content -->
    <section class="content">
      <div class="container-fluid">
        <div class="row">
          <div class="col-12">
            <!-- Default box -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Iniciar atención</h3>
                <div class="card-tools">
                  <button type="button" class="btn btn-tool" data-card-widget="collapse" data-toggle="tooltip" title="Collapse">
                    <i class="fas fa-minus"></i></button>                  
                </div>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-4">
                <div class="card card-primary">
                  <div class="card-header">
                    <h3 class="card-title">1.- Datos de la atención</h3>
                  </div>
                  <!-- /.card-header -->
                  <!-- form start -->
                  <form id="form" role="form" method="POST">
                    {% csrf_token %}
                    <div class="card-body">
                      <div class="form-group">
                        <label for="txtRutMedico">Rut Medico</label><label class="invisible" id="lblRutInvalidoMedico" >&nbsp;Debe ingresar un rut valido!.</label>
                        {{ form.rutMedico }}   
                      </div>
                      <div class="form-group">
                        <label for="txtNombreMedico">Nombre Medico</label>
                        {{ form.nombreMedico }}
                      </div>
                      <div class="form-group">
                        <label for="txtRutPaciente">Rut Paciente</label>
                        {{ form.rutPaciente }}
                      </div>
                      <div class="form-group">
                        <label for="txtNombrePaciente">Nombre Paciente</label>
                        {{ form.nombrePaciente }}
                      </div>
                      <div class="form-group">
                        <label for="exampleInputPassword1">Fecha</label>
                        {{ form.fecha }}
                      </div>
                      <div class="form-group">
                        <label for="txtProcedimiento">Consulta</label>
                        {{ form.consulta }}
                      </div>
                    </div>
                    <div class="card-footer">
                      <button type="button" id="btnDatos" onclick="terminar();"  class="btn btn-primary">Siguiente</button>
                    </div>
                 
                </div>
              </div>
              <div class="col-md-4">
                <div class="card card-primary">
                  <div class="card-header">
                    <h3 class="card-title">2.- Procedimientos</h3>
                  </div>
                  <!-- /.card-header -->
                  <!-- form start -->
              
               
                    <div class="card-body">
                      <div class="form-group">
                        <label for="txtProcedimiento">Procedimiento</label>
                        {{ form.procedimiento }}
                      </div>
                    </div>
                    <div class="card-footer">
                      <button type="button" class="btn btn-primary">Siguiente</button>
                    </div>
                 
                </div>
              </div>
              <div class="col-md-4">
                <div class="card card-primary">
                  <div class="card-header">
                    <h3 class="card-title">3.- Receta</h3>
                  </div>
                  <!-- /.card-header -->
                  <!-- form start -->
             
                    <div class="card-body">
                      <div class="form-group">
                        <label for="txtProcedimiento">Receta</label>
                        {{ form.receta }}
                      </div>
                    </div>
                    <div class="card-footer">
                      <button type="button" class="btn btn-primary"  onclick="submitForm();"   >Terminar Atencion</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
              </div>
              <!-- /.card-body -->
              <div class="card-footer">
                
              </div>
              <!-- /.card-footer-->
            </div>
            <!--tabla-->



            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Atenciones realizadas</h3>
                
                <div class="card-tools">
                  
                  <button type="button" class="btn btn-tool" data-card-widget="collapse" data-toggle="tooltip" title="Collapse">
                    <i class="fas fa-minus"></i></button>                  
                </div>
              </div>
              
               
                <!-- /.card-header -->
                <div class="card-body table-responsive p-0" style="height: 300px;">
                  <table class="table table-head-fixed text-nowrap">
                    <thead>
                      <tr>
                        <th>ID</th>
                        <th>Rut Medico</th>
                        <th>Nombre Medico</th>
                        <th>Rut Paciente</th>
                        <th>Nombre Paciente</th>  
                        <th>Fecha atencion</th>     
                        <th>Consulta</th>
                        <th>Procedimiento</th>
                        <th>Receta</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for x in atenciones %} 
                      <tr>
                        <td>{{ x.id_atencion}}</td>
                        <td>{{ x.rut_medico }}</td>
                        <td>{{ x.nombre_medico }}</td>
                        <td>{{ x.rut_paciente }}</td>
                        <td>{{ x.nombre_paciente }}</td>
                        <td>{{ x.fecha_atencion }}</td>
                        <td>{{ x.consulta }}</td>
                        <td>{{ x.procedimiento }}</td>
                        <td>{{ x.receta }}</td>
                        <td><button class="btn btn-danger"><i class="fas fa-window-close"></i></button>
                            <button class="btn btn-success"><i class="fas fa-pen-alt"></i></button>
                            <button class="btn btn-secondary" data-toggle="modal" data-target="#modal-default" ><i class="fas fa-print"></i></button>
                        </td> 
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
                <!-- /.card-body -->
            
              <!-- /.card -->
                  
                </div>
              </div>
            </div>
              </div>
              <!-- /.card-body -->
              <div class="card-footer">
                
              </div>
              <!-- /.card-footer-->
            </div>

            <!-- /.card -->
          </div>
        </div>    
    </div>
      </div><!-- /.container-fluid -->
      <div class="modal fade" id="modal-default">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h4 class="modal-title">Mensaje Siempre Sano</h4>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <p>Atencion registrada &hellip;</p>
            </div>
            <div class="modal-footer justify-content-between">
              <button type="button" class="btn btn-primary">ACEPTAR</button>
            </div>
          </div>
          <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
      </div>
    </section>
    <script>
      const load=()=>{
        $('#lblRutInvalidoMedico').hide();
      }

      const terminar=()=>{
        
        var rut=$('#txtRutMedico');
        validaRutText(rut);
      }
      
      var Fn = {
      // Valida el rut con su cadena completa "XXXXXXXX-X"
      validaRut : function (rutCompleto) {
      
        var tmp 	= rutCompleto.split('-');
        var digv	= tmp[1]; 
        var rut 	= tmp[0];
        if ( digv == 'K' ) digv = 'k' ;
        return (Fn.dv(rut) == digv );
      },
      dv : function(T){
        var M=0,S=1;
        for(;T;T=Math.floor(T/10))
          S=(S+T%10*(9-M++%6))%11;  
        return S?S-1:'k';
      }
    }

      function checkRut(rut) {
        // Despejar Puntos
        let rute=rut.value
        console.log(rute.split('.',''));
        var valor = rut.value.replace(".","")
        // Despejar Guión
        valor = valor.replace('-','');       
        // Aislar Cuerpo y Dígito Verificador
        cuerpo = valor.slice(0,-1);
        dv = valor.slice(-1).toUpperCase();       
        // Formatear RUN
        rut.value = cuerpo + '-'+ dv       

        
        // Si no cumple con el mínimo ej. (n.nnn.nnn)
        if(cuerpo.length < 7) { rut.setCustomValidity("RUT Incompleto"); return false;}        
        // Calcular Dígito Verificador
        suma = 0;
        multiplo = 2;        
        // Para cada dígito del Cuerpo
        for(i=1;i<=cuerpo.length;i++) {        
            // Obtener su Producto con el Múltiplo Correspondiente
            index = multiplo * valor.charAt(cuerpo.length - i);            
            // Sumar al Contador General
            suma = suma + index;            
            // Consolidar Múltiplo dentro del rango [2,7]
            if(multiplo < 7) { multiplo = multiplo + 1; } else { multiplo = 2; 
            }
          }

        // Calcular Dígito Verificador en base al Módulo 11
        dvEsperado = 11 - (suma % 11);
        
        // Casos Especiales (0 y K)
        dv = (dv == 'K')?10:dv;
        dv = (dv == 0)?11:dv;
        console.log(dvEsperado + ' ' + dv)
        // Validar que el Cuerpo coincide con su Dígito Verificador
        if(dvEsperado != dv) { rut.setCustomValidity("RUT Inválido"); return false; }  
        // Si todo sale bien, eliminar errores (decretar que es válido)
        rut.setCustomValidity('');  
      };    

      const siguienteDatos =()=>{
        $("#txtProcedimiento").focus();
      };

      const validaRutText=(a)=>{
        let rut=a.value;
        console.log('este es el rut: ' + rut);
        if(!Fn.validaRut(rut) ){
          $('#lblRutInvalidoMedico').removeClass();
          $('#lblRutInvalidoMedico').css('color','red');
         $('#txtRutMedico').focus();
          return false;
        }
        else{
          $('#lblRutInvalidoMedico').addClass('invisible')
          $('#txtProcedimiento').focus();
          return true;
        }
      };
      const validaRutTextBlur=(a)=>{
        let rut=a.value;
        console.log('este es el rut: ' + rut);
        if(!Fn.validaRut(rut) ){
          $('#lblRutInvalidoMedico').removeClass();
          $('#lblRutInvalidoMedico').css('color','red');
         $('#txtRutMedico').focus();
          return false;
        }
        else{
          $('#lblRutInvalidoMedico').addClass('invisible')
          $('#txtNombreMedico').focus();
          return true;
        }
      };
      const submitForm=()=>{
        
             $("#form").submit();
             $("#modal-default").modal("show");
      
      }

    </script>
{% endblock %}